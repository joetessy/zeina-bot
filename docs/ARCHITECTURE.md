# Zeina Architecture

## System Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ZeinaAssistant                                  â”‚
â”‚                     (assistant.py - Orchestrator)                        â”‚
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  State    â”‚   â”‚ Keyboard â”‚   â”‚  Thread  â”‚   â”‚  Conversation        â”‚ â”‚
â”‚  â”‚  Machine  â”‚   â”‚ Handler  â”‚   â”‚  Manager â”‚   â”‚  History             â”‚ â”‚
â”‚  â”‚          â”‚   â”‚ (pynput) â”‚   â”‚          â”‚   â”‚  (system + messages) â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Pipeline: Voice Mode

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  User       â”‚
                    â”‚  presses    â”‚
                    â”‚  SPACEBAR   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚    AudioRecorder       â”‚
              â”‚    (audio.py)          â”‚
              â”‚                        â”‚
              â”‚  Microphone â†’ Buffer   â”‚
              â”‚  Silero VAD monitors   â”‚
              â”‚  Auto-stop on silence  â”‚
              â”‚  (2s) or timeout (5s)  â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚ audio_data (numpy array)
                          â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚    Whisper ASR         â”‚
              â”‚    (openai-whisper)    â”‚
              â”‚                        â”‚
              â”‚  Audio â†’ Text          â”‚
              â”‚  Model: base (default) â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚ transcription (string)
                          â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  Intent Classification â”‚
              â”‚  (llama3.2:3b - fast)  â”‚
              â”‚                        â”‚
              â”‚  "Which tool needed?"  â”‚
              â”‚  â†’ web_search          â”‚
              â”‚  â†’ get_weather         â”‚
              â”‚  â†’ calculate           â”‚
              â”‚  â†’ get_current_time    â”‚
              â”‚  â†’ none                â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                   â”‚
          tool != none         tool == none
                â”‚                   â”‚
                â–¼                   â”‚
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
   â”‚   Tool Execution       â”‚       â”‚
   â”‚   (tools.py)           â”‚       â”‚
   â”‚                        â”‚       â”‚
   â”‚  Execute tool function â”‚       â”‚
   â”‚  Inject result as      â”‚       â”‚
   â”‚  assistant context msg â”‚       â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
               â”‚                    â”‚
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  Main LLM Response     â”‚
              â”‚  (llama3.1:8b)         â”‚
              â”‚                        â”‚
              â”‚  Full conversation     â”‚
              â”‚  history + tool contextâ”‚
              â”‚  â†’ Natural response    â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚ response text
                          â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚    Piper TTS           â”‚
              â”‚    (tts.py)            â”‚
              â”‚                        â”‚
              â”‚  Text â†’ WAV â†’ Playback â”‚
              â”‚  (pygame mixer)        â”‚
              â”‚  Interruptible         â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚    Auto-Listen         â”‚
              â”‚                        â”‚
              â”‚  Automatically starts  â”‚
              â”‚  listening for follow- â”‚
              â”‚  up (5s timeout)       â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Pipeline: Chat Mode

```
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  User types message    â”‚
              â”‚  (custom raw input)    â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚ text
                          â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  Intent Classification â”‚
              â”‚  (same as voice mode)  â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                    â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
                    â”‚           â”‚
              tool needed    no tool
                    â”‚           â”‚
                    â–¼           â”‚
              Tool Execution   â”‚
                    â”‚           â”‚
                    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  Main LLM Response     â”‚
              â”‚  (displayed as text,   â”‚
              â”‚   no TTS playback)     â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Tool Integration (Two-Step Pattern)

This design prevents the LLM from leaking tool reasoning into its spoken response.

```
Step 1: Classification (isolated call)            Step 2: Execution + Response
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                      â”‚    â”‚                                    â”‚
â”‚  User message â†’ Small fast model     â”‚    â”‚  Tool result injected as assistant â”‚
â”‚  (3b) with simple prompt:           â”‚    â”‚  context message:                  â”‚
â”‚                                      â”‚    â”‚                                    â”‚
â”‚  "Which tool? web_search |          â”‚    â”‚  "I looked this up for you.       â”‚
â”‚   get_weather | calculate |         â”‚    â”‚   Here's what I found: ..."       â”‚
â”‚   get_current_time | none"          â”‚    â”‚                                    â”‚
â”‚                                      â”‚    â”‚  Then main LLM (8b) generates    â”‚
â”‚  Returns: tool name or "none"        â”‚    â”‚  natural conversational response   â”‚
â”‚                                      â”‚    â”‚  (never sees tool schema)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Threading Model

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Main Thread                            â”‚
â”‚                                                               â”‚
â”‚  pynput Keyboard Listener                                    â”‚
â”‚  â”œâ”€â”€ SPACEBAR â†’ start_listening() / process / interrupt      â”‚
â”‚  â”œâ”€â”€ TAB â†’ toggle_mode()                                     â”‚
â”‚  â”œâ”€â”€ Ctrl+M â†’ change_model()                                 â”‚
â”‚  â””â”€â”€ ESC â†’ quit                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ spawns
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Face Animation      â”‚  â”‚  Audio Stream        â”‚  â”‚  Pipeline Thread â”‚
â”‚  Thread (daemon)     â”‚  â”‚  Thread (sounddevice) â”‚  â”‚  (daemon, per   â”‚
â”‚                      â”‚  â”‚                      â”‚  â”‚   interaction)  â”‚
â”‚  Cycles ASCII frames â”‚  â”‚  Mic callback feeds  â”‚  â”‚                 â”‚
â”‚  based on current    â”‚  â”‚  AudioRecorder       â”‚  â”‚  Transcribe â†’   â”‚
â”‚  state               â”‚  â”‚  VAD analysis        â”‚  â”‚  Classify â†’     â”‚
â”‚                      â”‚  â”‚                      â”‚  â”‚  [Tool] â†’ LLM â†’ â”‚
â”‚                      â”‚  â”‚                      â”‚  â”‚  TTS â†’ Auto-    â”‚
â”‚                      â”‚  â”‚                      â”‚  â”‚  listen          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Thread Safety:
  state_lock  â†’ protects RecordingState transitions
  mode_lock   â†’ protects InteractionMode transitions
  pause_face_updates flag â†’ prevents animation during chat input
```

## State Machine

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  IDLE   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚         â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜               â”‚
          â”‚              â”‚                    â”‚
          â”‚         spacebar /           no speech /
          â”‚         auto-listen          error /
          â”‚              â”‚               response done
          â”‚              â–¼                    â”‚
          â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
     timeout       â”‚ LISTENING â”‚              â”‚
     (no speech)   â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜              â”‚
          â”‚              â”‚                    â”‚
          â”‚         silence detected /        â”‚
          â”‚         spacebar                  â”‚
          â”‚              â”‚                    â”‚
          â”‚              â–¼                    â”‚
          â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”‚ PROCESSING â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  (transcribe â†’ classify â†’ [tool] â†’ LLM â†’ TTS)
```

## Display Layout (Terminal)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [Voice/Chat] mode    â”‚    Model: llama3.1:8b    â”‚  â† Menu Bar (line 1)
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                  â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚              â”‚   (â€¢ _ â€¢)      â”‚                  â”‚  â† Fixed Face Area
â”‚              â”‚                â”‚                  â”‚     (animated, ~8 lines)
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                                  â”‚
â”‚         ğŸ¤ Listening...                          â”‚  â† Status Line
â”‚         ASR: 1.23s | LLM: 0.89s                 â”‚  â† Detail Status
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€ You â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ What's the weather in London?             â”‚   â”‚  â† Scrolling Feed
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚     (Rich panels)
â”‚  ğŸ”§ Using tool: get_weather                     â”‚
â”‚  â”Œâ”€ Zeina â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ It's about twelve degrees in London right â”‚   â”‚
â”‚  â”‚ now with partly cloudy skies.             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Face area uses ANSI DECSTBM (scrolling region) so the feed
scrolls independently without overwriting the face.
```
